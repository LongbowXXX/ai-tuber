# AGENTS.md - Stage Director

> AI V-Tuber システムの舞台監督。MCP サーバーとして AI の指示をレンダリングエンジンへのコマンドに変換します。

このファイルは、このプロジェクトで作業する AI コーディングエージェントのためのコンテキストと指示を提供します。

## 1. エグゼクティブサマリー

**目的**: AI エージェント（Behavior Engine）とレンダリングエンジン（vtube-stage）の仲介を行い、キャラクターの操作を抽象化・制御すること。
**タイプ**: MCP サーバー / WebSocket サーバー
**ステータス**: 開発中 (Alpha) - Node.js 移行済み

## 2. アーキテクチャ & 技術スタック

### 主要技術

| カテゴリ       | テクノロジー              | バージョン | 用途                    |
| :------------- | :------------------------ | :--------- | :---------------------- |
| 言語           | TypeScript (Node.js)      | 18+        | メイン開発言語          |
| フレームワーク | Express / ws              | -          | WS & HTTP サーバー      |
| プロトコル     | @modelcontextprotocol/sdk | 1.0.1+     | AI エージェントとの通信 |
| バリデーション | Zod                       | 3.x        | データモデル            |

### アーキテクチャパターン

- **MCP (Model Context Protocol)**: AI エージェントに対して標準化されたインターフェース（ツール）を提供。
- **コマンドキューパターン**: 非同期に発生する AI からの指示をキューイングし、レンダリングエンジンの状態に合わせて順次実行。
- **イベント駆動**: `vtube-stage` からの `speakEnd` イベントをトリガーに次の処理へ移行。

## 3. ディレクトリ構造

```
[Project Root]/
├── docs/               # アーキテクチャ、ルール、フロー等の詳細ドキュメント
├── src/                # ソースコード
│   ├── services/       # ビジネスロジック
│   │   ├── CommandQueue.ts
│   │   └── WebSocketHandler.ts
│   ├── index.ts        # エントリーポイント
│   ├── server.ts       # サーバー設定
│   ├── mcp-server.ts   # MCP サーバー実装
│   └── types.ts        # 型定義
└── tests/              # テストコード
```

### 主要ディレクトリ

| ディレクトリ   | 目的                 | 主要ファイル               |
| :------------- | :------------------- | :------------------------- |
| `src/services` | コアビジネスロジック | `CommandQueue.ts`          |
| `docs/`        | 詳細ドキュメント     | `architecture/overview.md` |

## 4. 主要概念 (ユビキタス言語)

| 用語                  | 定義                               | 例                                                                                             |
| :-------------------- | :--------------------------------- | :--------------------------------------------------------------------------------------------- |
| **Stage Director**    | 本システム。AI と舞台の橋渡し役。  | -                                                                                              |
| **vtube-stage**       | リアルタイムレンダリングエンジン。 | -                                                                                              |
| **Speak**             | 発話と口パクを伴うアクション。     | `speak(character_id="default", message="こんにちは", caption="こんにちは", emotion="neutral")` |
| **Trigger Animation** | 特定のアニメーション再生。         | `trigger_animation(character_id="default", animation_name="wave")`                             |

## 5. エントリーポイント

| エントリーポイント | 場所           | 目的                                      |
| :----------------- | :------------- | :---------------------------------------- |
| メインサーバー     | `src/index.ts` | アプリケーションの起動（MCP & WebSocket） |

## 6. 開発ルール (憲法要約)

### 🔍 動的コンテキストプロトコル (調査フェーズ)

**全エージェントへの重要指示:**
このファイル (`AGENTS.md`) に提供されているコンテキストは**要約インデックス**です。タスクに必要なすべての詳細は含まれていません。
**タスクを開始する前に、必ず以下の手順を踏んでください:**

1.  **検索**: 利用可能なツールを使用して、ユーザーのリクエストに関連する `docs/` または `knowledge/` 内の特定のドキュメントを**キーワード/正規表現検索**または**セマンティック検索**で探してください。
2.  **リンクをたどる**: `AGENTS.md` は要約インデックスとして機能し、重要なファイルやフォルダへのリンクを提供しているため、詳細情報を得るためにこれらのリンクをたどらなければなりません。
3.  **読み込む**: これらの詳細ドキュメントの内容をコンテキストに読み込んでください。
4.  **相互参照**: 推測に頼らないでください。常に見つかった公式ドキュメントと照らし合わせて確認してください。

### 遵守事項

- **逐次問い合わせ**: 質問は一つずつ行ってください。
- **非同期処理**: `async/await` を使用すること。
- **型安全性**: 全てのコードに型定義を行うこと。

### 禁止事項

- `vtube-stage` との通信に WebSocket 以外のプロトコルを直接使用すること。
- `any` 型の乱用。

### 推奨パターン

- コマンド生成には Factory パターンを検討すること。
- 状態管理には `CommandQueue` の仕組みを利用すること。

## 7. クイックリファレンス

### 共通コマンド

```bash
# 開発サーバー起動
npm run dev

# テスト実行
npm test

# 型チェック & Lint
npm run lint
```

## 8. ドキュメントインデックス

詳細は以下のドキュメントを参照してください：

- [アーキテクチャ概要](docs/architecture/overview.md)
- [ディレクトリ構造](docs/architecture/directory-structure.md)
