# デバッグガイドライン：科学的方法

> **"デバッグは、あなたが殺人犯でもある犯罪映画の探偵になるようなものだ。"** — Filipe Fortes

このドキュメントは、Terraformer プロジェクトにおけるデバッグの標準プロセスとマインドセットを定義します。
バグ修正でもっとも重要なのは「素早く直すこと」ではなく、**「原因を確実に特定し、同じ問題が二度と起きないようにすること（再発防止／横展開）」** です。

## 1. 基本原則

### 🚫 推測禁止

「たぶんこれが原因」など推測に基づく修正（"Vibe Fix"）は厳禁です。
明確なスタックトレースやエラーログなしにコードを変更してはいけません。

- **悪い例**: 「非同期の問題っぽかったので `await` を足した。」
- **良い例**: 「実行順序を確認するログを入れ、データ取得前に参照されていることを確認したので `await` を追加した。」

### 🔗 論理的一貫性

バグ報告と修正提案は、次の 3 点を通して 1 本の線で論理的に接続されていなければなりません。

1.  **症状**: 何が起きているのか？
2.  **根本原因**: なぜ起きているのか？（メカニズム）
3.  **修正**: なぜこの修正で解決するのか？

「原因は不明だが、コードを書き直したら直った」は許されません。それはバグを隠し、副作用を生む可能性があります。

### 🛡️ 無害であること（Do No Harm）

「バグが直った」だけでは不十分です。「他が壊れていない」ことを確認したときに初めて修正は完了です。
修正対象コードが他の関数からどのように参照されているか（依存関係）を常に意識してください。

### 🌐 横展開（Yokoten / Horizontal Expansion）

**「ある場所で起きるバグは、他の場所でも起きているかもしれない」** と疑ってください。
原因が特定できたら、他ファイルに同様のコードパターンや同一ライブラリの誤用がないか確認し、その種の問題をプロジェクト全体から排除します。

## 2. 調査テクニック

### 🪵 計測（ログによる可視化 / Instrumentation）

エラー原因がログから即座に分からない場合、コードを見つめ続けるのではなく、**コードに喋らせてください**。

- **コンソールログ**: 変数値、関数の入出力、条件分岐結果をログに出す。
- **トレース ID**: 非同期処理が複数走る場合、リクエスト ID 等を付けて追跡可能にする。

> **ルール**: デバッグログは解決後に削除するか、適切なログレベル（例：DEBUG）へ変更しなければなりません。

### ⏳ タイミング & 並行性（Timing Issues の再現）

レースコンディションや非同期タイミング問題は、通常実行では再現が難しいことがあります。
その場合、**仮説を支えるために意図的に遅延（Sleep）を挿入**します。

- **仮説**: 「プロセス A がプロセス B より先に終了するためエラーが起きているのでは？」
- **検証**: プロセス A 直後に `sleep(5000)` を入れ、意図的にプロセス B を先行させる。
- **判断**: これで確実に再現できるなら仮説は正しい。排他制御や適切な待機処理を実装する。

### ✂️ 二分探索法（Bisection Method）

「いつ壊れたか」を特定することは、原因特定の近道です。

- **Git Bisect**: バージョン管理の bisect 機能で、バグ混入コミット（culprit）を特定する。

### 🔍 パターン検索（類似パターンの探索）

横展開のために IDE の検索機能や `grep` を使います。

- **正規表現検索**: そのバグを起こした記述パターン（例：`await` の忘れ、特定関数の誤用）を正規表現で検索する。
- **構造検索**: 単純な文字列検索で見つからない場合、AST（抽象構文木）ベースの検索を検討する。

## 3. @Debugger のワークフロー

AI エージェント（`@Debugger`）および人間開発者は、以下のフローに従わなければなりません。

1.  **観察（Observation）**
    - エラーメッセージ、ログ、ユーザー報告を読む。
2.  **仮説（Hypothesis）**
    - 「XX が YY であるため、ZZ のエラーが起きている」のように仮説を立てる。
3.  **実験（再現 / Experiment）**
    - **推測で修正コードを書く前に**、仮説を検証する。
    - 必要に応じてログ、`sleep`、再現テストを書く。
4.  **分析（Analysis）**
    - 具体的な原因箇所（ファイル、行番号）とロジック欠陥を特定する。
5.  **影響分析（Impact Analysis）**
    - 修正対象がどこから参照されているか（依存関係）を確認し、回帰リスクを評価する。
6.  **修正計画（Fix Planning）**
    - 根本原因を除去し、副作用を最小化する修正案を作る。
7.  **横展開（Yokoten / Horizontal Expansion）**
    - **Step**: バグを引き起こしたコードパターンを特定する。
    - **Action**: プロジェクト全体を検索して同様パターンの有無を確認する。
    - **Fix**: 見つかった場合、この修正スコープに含める（または別 Issue として起票する）。
8.  **検証（Verification & Regression Testing）**
    - **Step 1: 修正確認**: バグが直ったことを確認する。
    - **Step 2: 回帰なし確認**: 影響分析で特定した「関連機能」が正常動作することを確認する。

## 4. レビュアー向けチェックリスト

デバッグ修正の Pull Request（PR）をレビューする際は、次を確認します。

- [ ] **原因が明確か？**: 「なんとなく直った」になっていないか？
- [ ] **再現手順があるか？**: どのようにバグを確認したかが記述されているか？
- [ ] **影響範囲が考慮されているか？**: 修正箇所を利用する他機能への影響に言及があるか？
- [ ] **横展開（Yokoten）が行われたか？**: 「他の類似バグ」も確認した証跡があるか？
- [ ] **テストが十分か？**:
  - バグが直ったことを示すテスト（Positive Test）
  - 既存機能が壊れていないことを示すテスト（Regression Test）
