# 仕様ガイドライン: XML + Gherkin + Mermaid

このドキュメントは、`specification.template.md` で使用される構造化仕様フォーマットの思想と使い方を説明します。

## 1. 思想: なぜ今この組み合わせなのか？

従来、Gherkin は「自動テストのための中間言語」として扱われがちでした。しかし AI コーディングの時代では、その価値が劇的に変化しています。

### AI にとっての「究極のプロンプト」

LLM（Large Language Model）は構造化テキストを好みます。曖昧な自然言語仕様と比べ、Given/When/Then で区切られた Gherkin は、AI が文脈を正確に理解し、高精度なコードを生成する助けになります。さらに、Gherkin を書くプロセス自体が **Chain-of-Thought** 的なプロンプティングとして機能し、AI の推論精度を高めます。

### 「図」をコードとして理解する

複雑なフローや状態遷移をテキストだけで説明するのは困難です。**Mermaid** 記法を使えば、図を「テキスト（コード）」として記述できます。GitHub Copilot は Mermaid 構文を理解できるため、可視化されたロジック（分岐や状態遷移）を読み取り、実装コードやテストケースへ反映できます。

### 乖離を防ぐ（Living Documentation）

仕様（Feature ファイル）内に図（Mermaid）と振る舞い（Gherkin）を同居させることで、ドキュメントはコードと同じくバージョン管理され、陳腐化を防げます。

## 2. コンポーネントガイド

### XML コンテナ

これらのタグでセクションを包みます。AI パーサーが情報種別を見つけやすくなります。

- `<requirements>`: ビジネスルールとユーザーニーズ。
- `<technical_design>`: エンジニアリング仕様。
- `<gherkin>`: BDD シナリオ用の専用ブロック。
- `<mermaid_diagram>`: 図（ビジュアル）用の専用ブロック。

### Gherkin（振る舞い仕様）

受け入れ基準に使用します。

- **Feature（機能）**: 高レベルな機能。
- **Scenario（シナリオ）**: 振る舞いの具体例。
- **Given/When/Then**: 前提、行動、結果。

### Mermaid（ビジュアル仕様）

アーキテクチャやロジックフローに使用します。

- **Flowchart（フローチャート）**: 判断分岐、処理フロー。
- **Sequence Diagram（シーケンス図）**: 非同期プロセス、API 連携。
- **State Diagram（状態遷移図）**: ライフサイクル管理（例：注文ステータス）。

## 3. 複雑さを扱うためのガイド

仕様が複雑（分岐が多い、ロジックが深い）になると、単純な Gherkin の羅列は読めなくなります。複雑さを管理するために次の 3 パターンを使います。

### パターン A: `Rule` で構造化する（Gherkin 6.0）

バリエーションが多い複雑なビジネスロジックでは、Scenario を平坦に並べません。`Rule` キーワードでグルーピングします。

**悪い例（フラットなリスト）:**

```gherkin
シナリオ: 20歳未満のユーザーは購入できない
シナリオ: 20歳以上のユーザーは購入できる
シナリオ: 会員は割引を受けられる
シナリオ: 非会員は定価で支払う
```

**良い例（Rule による構造化）:**

```gherkin
機能: 商品購入

ルール: 年齢制限
  シナリオ: 20歳未満のユーザーは購入できない
    ...
  シナリオ: 20歳以上のユーザーは購入できる
    ...

ルール: 価格
  シナリオ: 会員は割引を受けられる
    ...
```

_利点: AI が論理的なグルーピングを理解でき、条件分岐ロジックのミスが減ります。_

### パターン B: Visual BDD（Mermaid）

循環フロー、複雑な非同期プロセス、状態機械（ステートマシン）ではテキストだけでは不十分です。

- **戦略**: Gherkin は「ハッピーパス」と「代表的なエラー」だけに使う。
- **全ロジック**: 網羅的な厳密ロジックは Mermaid 図に委譲する。
- **AI への指示**: 「Mermaid 図に基づいてエッジケースを実装してください。」

### パターン C: 宣言的ステップ（Screenplay パターン）

仕様に命令的で低レベルな UI 詳細を持ち込まないでください。実装詳細（How）ではなく、ユーザー意図（**What**）に集中します。

**悪い例（命令的）:**

```gherkin
もし ID フィールドをクリックしたとき
かつ "user" と入力したとき
かつ パスワードフィールドをクリックしたとき
かつ "pass" と入力したとき
かつ ログインボタンをクリックしたとき
```

**良い例（宣言的 - Screenplay 風）:**

```gherkin
もし 標準ユーザーとしてログインしたとき
```

_利点: 仕様を UI 実装から分離できます。`@Developer` のようなエージェントは、高レベル意図（"login"）を具体的コード（Playwright/Puppeteer の操作）へ落とし込むのが得意です。_
